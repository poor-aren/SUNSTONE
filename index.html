<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring (Realtime + Riwayat)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .loading-section{text-align:center;padding:20px;margin:20px}
    .loading-spinner{width:40px;height:40px;border:4px solid #ddd;border-top:4px solid #3b4998;border-radius:50%;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px;text-align:center}
    .result-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:10px}
    .detail-item{background:rgba(255,255,255,0.1);padding:8px;border-radius:6px}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginPage" class="page active" style="text-align:center;padding:50px">
      <h1 style="color:#3b4998;margin-bottom:30px;">SUNSTONE Admin Login</h1>
      <form id="loginForm" style="max-width:300px;margin:auto;">
        <input type="text" id="username" placeholder="Email" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <input type="password" id="password" placeholder="Password" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <button class="btn btn-primary" style="width:100%;">Login</button>
      </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">DASHBOARD</h1>
        <div class="nav-links">
          <button class="nav-btn active" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
        </div>
      </div>

      <div id="addPatientSection" class="add-patient-section">
        <h3>Tambah Pasien</h3>
        <form id="patientForm">
          <div class="form-row">
            <div class="form-group"><label>Nama</label><input id="patientName" required></div>
            <div class="form-group"><label>Umur</label><input id="patientAge" type="number" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>No HP</label><input id="patientPhone" required></div>
            <div class="form-group"><label>Index Brinkman</label><input id="brinkmanIndex" required></div>
          </div>
          <button class="btn btn-primary" type="submit">Mulai Sesi</button>
        </form>
      </div>

      <div id="currentPatientSection" class="current-patient" style="display:none">
        <h4>Pasien Aktif <span id="patientStatus" class="status-badge status-waiting">Menunggu Data</span></h4>
        <p><b>Nama:</b> <span id="currentName">-</span> | <b>Umur:</b> <span id="currentAge">-</span> | <b>HP:</b> <span id="currentPhone">-</span></p>
        <button class="btn btn-danger" onclick="finishSession()">Selesai</button>
      </div>

      <div id="loadingSection" class="loading-section" style="display:none">
        <div class="loading-spinner"></div>
        <p id="realtimeStatus">Menunggu data sensor...</p>
      </div>

      <div id="resultSection" class="result-section" style="display:none">
        <h3>Hasil Machine Learning (Realtime)</h3>
        <p>Kategori PPOK: <b id="resultCategory">-</b></p>
        <p>Confidence: <b id="resultConfidence">-</b></p>
        <h4>Data Sensor Terbaru</h4>
        <div id="resultDetails" class="result-details"></div>
      </div>

      <!-- Riwayat -->
      <div id="historySection" style="display:none;padding:20px">
        <h2 style="color:#3b4998">Riwayat Pemeriksaan</h2>
        <table>
          <thead><tr><th>Tanggal</th><th>Nama</th><th>Hasil</th><th>Confidence</th><th>Aksi</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminPage" class="page">
      <div class="admin-page">
        <h1 style="color:#3b4998;margin-bottom:10px;">ADMIN PANEL</h1>
        <div class="nav-links" style="margin-bottom:15px">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn active" onclick="showAdmin(event)">Admin</button>
        </div>
        <table class="status-table">
          <tr><th>Service</th><th>Status</th></tr>
          <tr><td>IoT Core</td><td id="iotStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>Lambda</td><td id="lambdaStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>DynamoDB</td><td id="dynamoStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>API Gateway</td><td id="apiStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>CloudFront/S3</td><td id="cdnStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
        </table>
        <button class="btn btn-primary" onclick="refreshAWSStatus()">Refresh Status</button>
        <h3 style="margin-top:20px;">System Logs</h3>
        <div id="logContainer" class="log-container"></div>
      </div>
    </div>
  </div>

<script>
/* === CONFIG ======================================= */
const API = {
  url: "https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239",
  key: "dummy"
};
/* ================================================== */

let authToken = null;

document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  try {
    const res = await fetch(`${API.url}/login`, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        "x-api-key": API.key
      },
      body: JSON.stringify({
        email: document.getElementById("username").value,
        password: document.getElementById("password").value
      })
    });
    const data = await res.json();
    if(res.ok && data.ok){
      authToken = data.token;
      document.getElementById("loginPage").classList.remove("active");
      document.getElementById("dashboardPage").classList.add("active");
      alert("Login sukses!");
    } else {
      alert("Login gagal: " + (data.error || "unknown"));
    }
  } catch(err){
    alert("Error: " + err.message);
  }
});

function showDashboard(ev){
  setActive("dashboardPage", ev.target);
}
function showHistory(ev){
  setActive("historySection", ev.target);
}
function showAdmin(ev){
  setActive("adminPage", ev.target);
}
function setActive(id, btn){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  if(id==="historySection"){
    document.getElementById("dashboardPage").classList.add("active");
    document.getElementById("historySection").style.display="block";
  } else {
    document.getElementById(id).classList.add("active");
  }
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
</script>
</body>
</html>
