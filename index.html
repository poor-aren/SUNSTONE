<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PKM - Dashboard</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444;
      --card:#0b1220; --br:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1c 60%,#09101a);
      color:var(--text);font:500 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .logo{width:38px;height:38px;border-radius:10px;
      background:radial-gradient(120% 120% at 0% 0%,#53c3ff,transparent 60%),
                 radial-gradient(120% 120% at 100% 100%,#22c55e,transparent 60%),#0b1424}
    .title{font-weight:700;font-size:18px;}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px;grid-template-columns: repeat(12,1fr)}
    .card{grid-column: span 12;background:linear-gradient(180deg,#0c1426,#0b1120);
      border:1px solid #132036;border-radius:var(--br); padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)}
    @media(min-width:900px){
      .c4{grid-column: span 4}.c6{grid-column: span 6}.c8{grid-column: span 8}.c12{grid-column: span 12}
    }
    .card h3{margin:0 0 10px;font-size:15px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button,textarea{
      font:inherit;color:inherit; background:#0a1426; border:1px solid #1a2940; border-radius:10px;
      padding:10px 12px; outline:none; width:100%;
    }
    input:focus,textarea:focus,select:focus{border-color:#2f69ff; box-shadow: 0 0 0 3px rgba(59,130,246,.25)}
    button{cursor:pointer; width:auto; background:linear-gradient(180deg,#1e3a8a,#1f2b57);
      border:1px solid #2b4b9a; padding:10px 14px}
    button.primary{background:linear-gradient(180deg,#16a34a,#0f7a39); border-color:#1b9a50}
    button.ghost{background:transparent;border-color:#2a3b56}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:#0a1324;border:1px solid #12213a;font-size:12px}
    pre{background:#070d18;border:1px solid #12213a;border-radius:12px;padding:12px;overflow:auto;max-height:320px}
    .ok{color:var(--accent)} .bad{color:var(--danger)} .warn{color:var(--warn)}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{background:#0a1324;border:1px solid #12213a;border-radius:12px;padding:10px 12px}
    .k{color:#7dd3fc} .v{color:#bbf7d0}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo"></div>
      <div>
        <div class="title">PKM Dashboard</div>
        <div class="muted">Flow: buka sesi → ESP kirim sensor → simpan hasil → tutup sesi</div>
      </div>
      <span class="pill" id="conn-pill">Status: <b class="bad">Belum dicek</b></span>
    </div>

    <div class="grid">
      <!-- KONFIG -->
      <div class="card c12">
        <h3>Konfigurasi</h3>
        <div class="row">
          <div><label>API URL</label><input id="api-url" /></div>
          <div><label>API Key</label><input id="api-key" /></div>
          <div><label>Device ID</label><input id="device-id" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" id="btn-apply">Terapkan</button>
          <button id="btn-test">Test Koneksi</button>
        </div>
        <div class="hint">Tombol “Test Koneksi” akan GET <code>/history</code>. Kalau OK akan tampil daftar pasien.</div>
        <pre id="test-output" hidden></pre>
      </div>

      <!-- SESI -->
      <div class="card c6">
        <h3>1) Buka Sesi</h3>
        <div class="row">
          <div><label>Nama</label><input id="name" placeholder="mis. Ali" /></div>
          <div><label>No. HP</label><input id="phone" placeholder="mis. 08123456" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="btn-open">Buka Sesi</button>
          <button class="ghost" id="btn-history">Lihat History</button>
        </div>
        <pre id="open-output" hidden></pre>
        <div class="hint">Setelah buka sesi, Device ID akan dipetakan → data sensor dari ESP masuk ke sesi ini.</div>
      </div>

      <div class="card c6">
        <h3>2) Sensor & Hasil</h3>
        <div class="row">
          <div><label>ID Sesi (patient_id)</label><input id="pid" placeholder="mis. Ali_08123456" /></div>
          <div><label>Limit Items</label><input id="limit" type="number" value="5" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btn-sensors">Ambil Sensor</button>
          <button id="btn-latest" class="ghost">Ambil Latest Result</button>
        </div>

        <div style="margin-top:10px;border-top:1px dashed #20304a;padding-top:10px">
          <div class="row">
            <div><label>Kategori</label><input id="res-cat" placeholder="Normal / Tinggi" /></div>
            <div><label>Confidence</label><input id="res-conf" type="number" step="0.01" value="0.80" /></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="btn-save-result">Simpan Result</button>
          </div>
        </div>

        <pre id="sensor-output" hidden></pre>
      </div>

      <!-- TUTUP SESI -->
      <div class="card c6">
        <h3>3) Tutup Sesi</h3>
        <div class="row">
          <div><label>ID Sesi (patient_id)</label><input id="pid-finish" placeholder="mis. Ali_08123456" /></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="warn" id="btn-finish">Tutup Sesi</button>
        </div>
        <pre id="finish-output" hidden></pre>
      </div>

      <!-- HISTORY -->
      <div class="card c6">
        <h3>History Pasien</h3>
        <div id="history-list" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // === KONFIGURASI API (sudah diisi sesuai env kamu) ===
    const DEFAULTS = {
      url: "https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239",
      key: "75179e4b24c0179f1806d2a18707e7cb",
      deviceId: "ESP01",
    };

    // Simpan/ambil dari localStorage supaya nggak ngetik ulang
    const cfg = {
      get url(){ return localStorage.getItem("api_url") || DEFAULTS.url; },
      set url(v){ localStorage.setItem("api_url", v); },
      get key(){ return localStorage.getItem("api_key") || DEFAULTS.key; },
      set key(v){ localStorage.setItem("api_key", v); },
      get deviceId(){ return localStorage.getItem("api_device") || DEFAULTS.deviceId; },
      set deviceId(v){ localStorage.setItem("api_device", v); },
    };

    // Helper kecil
    const $ = (id) => document.getElementById(id);
    const show = (el, ok=true) => { el.hidden = !ok; };
    const j = (x) => JSON.stringify(x, null, 2);

    function applyConfigToInputs(){
      $("api-url").value = cfg.url;
      $("api-key").value = cfg.key;
      $("device-id").value = cfg.deviceId;
    }

    function updateStatus(ok, msgOk="Terhubung", msgBad="Gagal"){
      const pill = $("conn-pill");
      pill.innerHTML = `Status: <b class="${ok?'ok':'bad'}">${ok?msgOk:msgBad}</b>`;
    }

    async function apiFetch(path, options={}){
      const url = cfg.url.replace(/\/+$/,'') + path;
      const headers = Object.assign(
        { "x-api-key": cfg.key },
        (options.headers || {})
      );
      const res = await fetch(url, { ...options, headers });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
      }
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    // ====== Actions ======
    async function testConnection(){
      const out = $("test-output");
      try{
        const data = await apiFetch("/history");
        out.textContent = j(data);
        show(out,true);
        updateStatus(true, "OK");
        renderHistory(data.patients||[]);
      }catch(err){
        out.textContent = String(err);
        show(out,true);
        updateStatus(false, "Gagal");
      }
    }

    async function openSession(){
      const name = $("name").value.trim();
      const phone = $("phone").value.trim();
      const device_id = cfg.deviceId = $("device-id").value.trim() || DEFAULTS.deviceId;
      $("api-url").value && (cfg.url = $("api-url").value.trim());
      $("api-key").value && (cfg.key = $("api-key").value.trim());

      const out = $("open-output");
      try{
        const body = { name, phone, device_id };
        const data = await apiFetch("/session", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body)
        });
        out.textContent = j(data);
        show(out,true);
        $("pid").value = `${name}_${phone}`;
        $("pid-finish").value = `${name}_${phone}`;
        await testConnection(); // refresh history
      }catch(err){
        out.textContent = String(err);
        show(out,true);
      }
    }

    async function getSensors(){
      const pid = $("pid").value.trim();
      const limit = Math.max(1, parseInt($("limit").value||"5",10));
      const out = $("sensor-output");
      try{
        const data = await apiFetch(`/session/${encodeURIComponent(pid)}/sensors?limit=${limit}`);
        out.textContent = j(data);
        show(out,true);
      }catch(err){
        out.textContent = String(err);
        show(out,true);
      }
    }

    async function getLatest(){
      const pid = $("pid").value.trim();
      const out = $("sensor-output");
      try{
        const data = await apiFetch(`/session/${encodeURIComponent(pid)}/latest`);
        out.textContent = j(data);
        show(out,true);
      }catch(err){
        out.textContent = String(err);
        show(out,true);
      }
    }

    async function saveResult(){
      const pid = $("pid").value.trim();
      const category = $("res-cat").value.trim() || "Normal";
      const confidence = parseFloat($("res-conf").value || "0.8");
      const body = { category, confidence, device_id: cfg.deviceId };
      const out = $("sensor-output");
      try{
        const data = await apiFetch(`/session/${encodeURIComponent(pid)}/result`, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body)
        });
        out.textContent = j({saved:data, hint:"Pakai tombol 'Ambil Latest Result' untuk melihatnya"});
        show(out,true);
      }catch(err){
        out.textContent = String(err);
        show(out,true);
      }
    }

    async function finishSession(){
      const pid = $("pid-finish").value.trim();
      const out = $("finish-output");
      try{
        const data = await apiFetch(`/session/${encodeURIComponent(pid)}/finish`, { method:"POST" });
        out.textContent = j(data);
        show(out,true);
        await testConnection(); // refresh history
      }catch(err){
        out.textContent = String(err);
        show(out,true);
      }
    }

    function renderHistory(items){
      const host = $("history-list");
      host.innerHTML = "";
      (items||[]).forEach(it=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div><span class="k">id</span>: <span class="v">${it.id}</span></div>
          <div><span class="k">status</span>: <span class="v">${it.status||'-'}</span></div>
          <div><span class="k">start</span>: <span class="v">${it.sessionStart||'-'}</span></div>
          <div><span class="k">last</span>: <span class="v">${it.lastResultTimestamp||'-'}</span></div>
          <div><span class="k">category</span>: <span class="v">${it.lastResultCategory||'-'}</span></div>
          <div><span class="k">device</span>: <span class="v">${it.device_id||'-'}</span></div>
        `;
        host.appendChild(div);
      });
      if(!items || !items.length){
        host.innerHTML = `<div class="muted">Belum ada data.</div>`;
      }
    }

    async function loadHistory(){
      try{
        const data = await apiFetch("/history");
        renderHistory(data.patients||[]);
        updateStatus(true, "OK");
      }catch{ /* diam */ }
    }

    // ====== wire events ======
    window.addEventListener("DOMContentLoaded", ()=>{
      applyConfigToInputs();
      $("btn-apply").addEventListener("click", ()=>{
        cfg.url = $("api-url").value.trim();
        cfg.key = $("api-key").value.trim();
        cfg.deviceId = $("device-id").value.trim();
      });
      $("btn-test").addEventListener("click", testConnection);
      $("btn-open").addEventListener("click", openSession);
      $("btn-history").addEventListener("click", loadHistory);
      $("btn-sensors").addEventListener("click", getSensors);
      $("btn-latest").addEventListener("click", getLatest);
      $("btn-save-result").addEventListener("click", saveResult);
      $("btn-finish").addEventListener("click", finishSession);

      // coba ping awal (silent)
      loadHistory();
    });
  </script>
</body>
</html>
