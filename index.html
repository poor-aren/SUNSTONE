<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring (Realtime + Riwayat)</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .loading-section{text-align:center;padding:20px;margin:20px}
    .loading-spinner{width:40px;height:40px;border:4px solid #ddd;border-top:4px solid #3b4998;border-radius:50%;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px;text-align:center}
    .result-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:10px}
    .detail-item{background:rgba(255,255,255,0.1);padding:8px;border-radius:6px}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginPage" class="page active" style="text-align:center;padding:50px">
      <h1 style="color:#3b4998;margin-bottom:30px;">SUNSTONE Admin Login</h1>
      <form id="loginForm" style="max-width:300px;margin:auto;">
        <input type="text" id="username" placeholder="Username" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <input type="password" id="password" placeholder="Password" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <button class="btn btn-primary" style="width:100%;">Login</button>
      </form>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">DASHBOARD</h1>
        <div class="nav-links">
          <button class="nav-btn active" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
        </div>
      </div>

      <div id="addPatientSection" class="add-patient-section">
        <h3>Tambah Pasien</h3>
        <form id="patientForm">
          <div class="form-row">
            <div class="form-group"><label>Nama</label><input id="patientName" required></div>
            <div class="form-group"><label>Umur</label><input id="patientAge" type="number" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>No HP</label><input id="patientPhone" required></div>
            <div class="form-group"><label>Index Brinkman</label><input id="brinkmanIndex" required></div>
          </div>
          <button class="btn btn-primary" type="submit">Mulai Sesi</button>
        </form>
      </div>

      <div id="currentPatientSection" class="current-patient" style="display:none">
        <h4>Pasien Aktif <span id="patientStatus" class="status-badge status-waiting">Menunggu Data</span></h4>
        <p><b>Nama:</b> <span id="currentName">-</span> | <b>Umur:</b> <span id="currentAge">-</span> | <b>HP:</b> <span id="currentPhone">-</span></p>
        <button class="btn btn-danger" onclick="finishSession()">Selesai</button>
      </div>

      <div id="loadingSection" class="loading-section" style="display:none">
        <div class="loading-spinner"></div>
        <p id="realtimeStatus">Menunggu data sensor...</p>
      </div>

      <div id="resultSection" class="result-section" style="display:none">
        <h3>Hasil Machine Learning (Realtime)</h3>
        <p>Kategori PPOK: <b id="resultCategory">-</b></p>
        <p>Confidence: <b id="resultConfidence">-</b></p>
        <h4>Data Sensor Terbaru</h4>
        <div id="resultDetails" class="result-details"></div>
      </div>

      <!-- Riwayat -->
      <div id="historySection" style="display:none;padding:20px">
        <h2 style="color:#3b4998">Riwayat Pemeriksaan</h2>
        <table>
          <thead><tr><th>Tanggal</th><th>Nama</th><th>Hasil</th><th>Confidence</th><th>Aksi</th></tr></thead>
        <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminPage" class="page">
      <div class="admin-page">
        <h1 style="color:#3b4998;margin-bottom:10px;">ADMIN PANEL</h1>
        <div class="nav-links" style="margin-bottom:15px">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn active" onclick="showAdmin(event)">Admin</button>
        </div>
        <table class="status-table">
          <tr><th>Service</th><th>Status</th></tr>
          <tr><td>IoT Core</td><td id="iotStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>Lambda</td><td id="lambdaStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>DynamoDB</td><td id="dynamoStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>API Gateway</td><td id="apiStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
          <tr><td>CloudFront/S3</td><td id="cdnStatus">ðŸŸ¡ Checkingâ€¦</td></tr>
        </table>
        <button class="btn btn-primary" onclick="refreshAWSStatus()">Refresh Status</button>
        <h3 style="margin-top:20px;">System Logs</h3>
        <div id="logContainer" class="log-container"></div>
      </div>
    </div>
  </div>

<script>
/* === CONFIG (ISI DENGAN PUNYAMU) ======================================= */
const API = {
  url: "https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com/tros-20251007091134-4239",
  key: "75179e4b24c0179f1806d2a18707e7cb",
  deviceId: "ESP01"
};
/* ====================================================================== */

let currentPatient = null;
let polling = null;
let lastSensorSK = null;
let testHistory = [];
const HIDDEN_IDS_KEY = 'sunstone.hiddenHistoryIds';
const SESSION_KEY = 'sunstone.session';

// ---- Page navigation (desain tetap) ----
function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');}
function showDashboard(e){showPage('dashboardPage');toggleSections('add');if(e)updateNav(e);enforceSingleOpenUI();}
function showAdmin(e){showPage('adminPage');if(e)updateNav(e);refreshAWSStatus();}
function showHistory(e){showPage('dashboardPage');toggleSections('history');if(e)updateNav(e);loadHistoryFromAPI();}
function updateNav(e){document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));e.target.classList.add('active');}
function toggleSections(target){
  addPatientSection.style.display= target==='add'?'block':'none';
  currentPatientSection.style.display='none';
  loadingSection.style.display='none';
  resultSection.style.display='none';
  historySection.style.display= target==='history'?'block':'none';
}

// ---- Login (dummy) ----
document.getElementById('loginForm').addEventListener('submit',e=>{
  e.preventDefault();showPage('dashboardPage');resumeSessionIfAny();
});

// ---- Helper API ----
async function callAPI(path, method='GET', body=null){
  const opts = { method, headers:{'content-type':'application/json','x-api-key':API.key} };
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch(API.url + path, opts);
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error(`API ${method} ${path} -> ${res.status} ${t}`);
  }
  return res.json();
}

// ---- Cari sesi OPEN (global 1 saja) ----
async function getOpenSessionId(){
  const js = await callAPI('/history','GET');
  const open = (js.patients||[]).find(p => p.status === 'OPEN');
  return open ? open.id : null;
}

// ---- Simpan/restore sesi agar tahan refresh ----
function saveSession(obj){ try{ localStorage.setItem(SESSION_KEY, JSON.stringify(obj)); }catch{} }
function clearSession(){ try{ localStorage.removeItem(SESSION_KEY); }catch{} }

async function resumeSessionIfAny(){
  // 1) Cek sesi OPEN di server
  let openId = null;
  try { openId = await getOpenSessionId(); } catch {}
  // 2) Cek localStorage
  let s = null; try{ s = JSON.parse(localStorage.getItem(SESSION_KEY)||'null'); }catch{}
  const resumeId = openId || (s && s.id);

  if(!resumeId){
    // tidak ada sesi aktif â†’ tampilkan form
    toggleSections('add');
    return;
  }
  // ada sesi aktif â†’ tampilkan UI sesi, tanpa buka sesi baru
  attachUIToSession(resumeId, s?.name, s?.age, s?.phone);
}

// ---- Terapkan UI ke sesi aktif tertentu ----
function attachUIToSession(sessionId, name, age, phone){
  currentPatient = { sessionId, name: name||'-', age: age||'-', phone: phone||'-' };
  addPatientSection.style.display='none';
  currentPatientSection.style.display='block';
  loadingSection.style.display='block';
  resultSection.style.display='block';
  currentName.textContent=currentPatient.name;
  currentAge.textContent=currentPatient.age;
  currentPhone.textContent=currentPatient.phone;
  patientStatus.textContent='Aktif'; patientStatus.className='status-badge status-processing';
  saveSession({ id: sessionId, name: currentPatient.name, age: currentPatient.age, phone: currentPatient.phone });
  startPollingSensors();
}

// ---- Mulai sesi (blokir bila sudah ada OPEN) ----
document.getElementById('patientForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  try{
    // Cegah buka sesi baru jika sudah ada yang OPEN
    const openId = await getOpenSessionId();
    if (openId) {
      alert(`Sudah ada sesi aktif: ${openId}. Selesaikan dulu sebelum membuka sesi baru.`);
      attachUIToSession(openId); // switch UI ke sesi yang sedang aktif
      return;
    }

    const p = {
      name: patientName.value.trim(),
      age: patientAge.value,
      phone: patientPhone.value.trim(),
      brink: brinkmanIndex.value.trim()
    };

    // Panggil API open session; handle 409 kalau race
    const res = await fetch(API.url + '/session', {
      method:'POST',
      headers:{'content-type':'application/json','x-api-key':API.key},
      body: JSON.stringify({ name:p.name, phone:p.phone, device_id: API.deviceId })
    });

    if (res.status === 409) {
      const j = await res.json().catch(()=>({}));
      const sid = j?.current_open;
      alert(`Sesi sudah ada: ${sid}. Kamu tidak bisa membuka sesi baru sebelum menutupnya.`);
      attachUIToSession(sid);
      return;
    }
    if (!res.ok) {
      const t = await res.text().catch(()=>res.statusText);
      throw new Error(`API /session ${res.status} ${t}`);
    }
    const resp = await res.json();
    const sessionId = resp.id || `${p.name}_${p.phone}`;
    currentPatient = { ...p, sessionId };
    saveSession({ id: sessionId, name: p.name, age: p.age, phone: p.phone });

    // tampilkan section aktif
    addPatientSection.style.display='none';
    currentPatientSection.style.display='block';
    loadingSection.style.display='block';
    resultSection.style.display='block';
    currentName.textContent=p.name; currentAge.textContent=p.age; currentPhone.textContent=p.phone;
    patientStatus.textContent='Aktif'; patientStatus.className='status-badge status-processing';

    // mulai polling sensor
    startPollingSensors();
  }catch(err){
    alert('Gagal mulai sesi: ' + err.message);
  }
});

function startPollingSensors(){
  clearInterval(polling); lastSensorSK = null;
  polling = setInterval(async ()=>{
    try{
      if(!currentPatient?.sessionId) return;
      const { items=[] } = await callAPI(`/session/${currentPatient.sessionId}/sensors?limit=1`,'GET');
      if(items.length){
        const it = items[0];
        realtimeStatus.textContent = `Data masuk (${it.timestamp})`;
        renderSensorValues(it.sensor_values);
        if(it.SK !== lastSensorSK){
          lastSensorSK = it.SK;
          const {category, confidence} = simpleInference(it.sensor_values);
          updateResultUI(category, confidence, it.sensor_values);
          await callAPI(`/session/${currentPatient.sessionId}/result`, 'POST', {
            category, confidence, sensor_values: it.sensor_values, device_id: API.deviceId
          });
        }
      }else{
        realtimeStatus.textContent = 'Menunggu data sensor...';
      }
    }catch(err){
      console.warn(err);
      realtimeStatus.textContent = 'Gagal ambil data sensor.';
    }
  }, 1200);
}

function renderSensorValues(values){
  const labels = ['S1','S2','S3','S4'];
  const html = (values||[]).map((v,i)=>`<div class='detail-item'><b>${v}</b><br><small>${labels[i]||('S'+(i+1))}</small></div>`).join('');
  resultDetails.innerHTML = html;
}

function simpleInference(values){
  const avg = (values||[]).reduce((a,b)=>a+Number(b||0),0)/Math.max((values||[]).length,1);
  let category='Rendah';
  if(avg>=80) category='Tinggi';
  else if(avg>=40) category='Sedang';
  const confidence = Math.min(0.95, 0.6 + (avg/200)).toFixed(2);
  return { category, confidence: Number(confidence) };
}

function updateResultUI(category, confidence, values){
  resultCategory.textContent = category;
  resultConfidence.textContent = confidence.toString();
  loadingSection.style.display='none';
  resultSection.style.display='block';
  renderSensorValues(values);
}

// ---- Selesai sesi ----
async function finishSession(){
  if(!currentPatient?.sessionId) return;
  try{
    clearInterval(polling);
    await callAPI(`/session/${currentPatient.sessionId}/finish`,'POST');
    patientStatus.textContent='Sesi Selesai';
    patientStatus.className='status-badge status-completed';
    clearSession();
    alert('Sesi ditutup.');
    toggleSections('add');
    // setelah tutup, tidak ada sesi OPEN â†’ form bisa dipakai lagi
    await loadHistoryFromAPI();
    currentPatient = null;
  }catch(err){
    alert('Gagal menutup sesi: ' + err.message);
  }
}

// ---- Riwayat (ambil dari backend) ----
function getHiddenIds(){
  try{ return JSON.parse(localStorage.getItem(HIDDEN_IDS_KEY)||'[]'); }catch{ return []; }
}
function setHiddenIds(arr){
  try{ localStorage.setItem(HIDDEN_IDS_KEY, JSON.stringify(arr)); }catch{}
}

async function loadHistoryFromAPI(){
  const body = document.getElementById('historyBody');
  body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#777">Memuat...</td></tr>';
  try{
    const { patients=[] } = await callAPI('/history','GET');
    const hidden = new Set(getHiddenIds());
    testHistory = patients
      .filter(p => !hidden.has(p.id))
      .map(p => ({
        date: p.lastResultTimestamp || p.sessionStart || '-',
        name: (p.id||'-').split('_')[0],
        fullId: p.id,
        status: p.status,
        category: p.lastResultCategory || '-',
        confidence: 'â€”'
      }))
      .sort((a,b)=> (b.date||'').localeCompare(a.date||''));
    renderHistoryTable(testHistory);
  }catch(err){
    body.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#b00">Gagal memuat riwayat: ${err.message}</td></tr>`;
  }
}

function renderHistoryTable(rows){
  const body = document.getElementById('historyBody');
  if(!rows.length){
    body.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#777">Belum ada riwayat</td></tr>';
    return;
  }
  body.innerHTML = '';
  rows.forEach((r)=>{
    const tr = document.createElement('tr');
    const actionBtn = r.status === 'OPEN'
      ? `<button class='btn btn-danger btn-sm' onclick='closeFromHistory("${r.fullId}")'>Tutup</button>`
      : `<button class='btn btn-success btn-sm' onclick='viewFromHistory("${r.fullId}")'>Buka</button>
         <button class='btn btn-danger btn-sm' onclick='hideHistory("${r.fullId}")'>Hapus</button>`;
    tr.innerHTML = `
      <td>${r.date||'-'}</td>
      <td>${r.name||'-'}</td>
      <td>${r.category||'-'}</td>
      <td>${r.confidence||'-'}</td>
      <td>${actionBtn}</td>`;
    body.appendChild(tr);
  });
}

async function closeFromHistory(id){
  try{
    await callAPI(`/session/${id}/finish`,'POST');
    await loadHistoryFromAPI();
    alert('Sesi ditutup.');
    // kalau kita sedang melampirkan UI ke sesi yang ditutup â†’ lepaskan
    const s = JSON.parse(localStorage.getItem(SESSION_KEY)||'null');
    if (s?.id === id) {
      clearSession();
      currentPatient = null;
      toggleSections('add');
    }
  }catch(e){
    alert('Gagal menutup: ' + e.message);
  }
}

function hideHistory(id){
  const hidden = getHiddenIds();
  if(!hidden.includes(id)) hidden.push(id);
  setHiddenIds(hidden);
  loadHistoryFromAPI();
}

function viewFromHistory(id){
  showDashboard();
  toggleSections('add');
  alert(`Meninjau riwayat: ${id}\n(untuk pemeriksaan baru silakan "Mulai Sesi" lagi)`);
}

// ==================== ADMIN (REAL CHECK) ====================
function setStatus(id, state, text) {
  const el = document.getElementById(id);
  const dot = state === 'ok' ? 'ðŸŸ¢'
            : state === 'warn' ? 'ðŸŸ¡'
            : state === 'err' ? 'ðŸ”´' : 'âšª';
  el.textContent = `${dot} ${text}`;
}
function adminLog(msg) {
  const box = document.getElementById('logContainer');
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  const div = document.createElement('div');
  div.className = 'log-entry';
  div.textContent = line;
  box.prepend(div);
  while (box.children.length > 120) box.removeChild(box.lastChild);
}

async function checkAPI() {
  const t0 = performance.now();
  const res = await fetch(`${API.url}/history`, { headers: { 'x-api-key': API.key }});
  if (!res.ok) throw new Error(`API /history ${res.status}`);
  const js = await res.json();
  const ms = Math.round(performance.now() - t0);
  setStatus('apiStatus', 'ok', `Online (${ms}ms)`);
  setStatus('lambdaStatus', 'ok', 'Online (via API)');
  setStatus('dynamoStatus', Array.isArray(js.patients) ? 'ok' : 'warn',
            Array.isArray(js.patients) ? 'Online' : 'Online (no data)');
  adminLog(`API /history OK (${ms}ms), patients=${Array.isArray(js.patients) ? js.patients.length : 0}`);
  return js;
}

async function checkIoT(historyJson) {
  let sid = null;
  try { sid = JSON.parse(localStorage.getItem(SESSION_KEY)||'null')?.id || null; } catch {}
  if (!sid && historyJson && Array.isArray(historyJson.patients)) {
    sid = (historyJson.patients.find(p => p.status === 'OPEN')||{}).id || null;
  }
  if (!sid) {
    setStatus('iotStatus', 'warn', 'Perlu sesi aktif');
    adminLog('IoT: tidak ada sesi aktif untuk dites');
    return;
  }
  const r = await fetch(`${API.url}/session/${encodeURIComponent(sid)}/sensors?limit=1`, {
    headers: { 'x-api-key': API.key }
  });
  if (!r.ok) throw new Error(`API /sensors ${r.status}`);
  const { items=[] } = await r.json();
  if (!items.length) {
    setStatus('iotStatus','warn','Tidak ada data');
    adminLog(`IoT: /sensors OK namun belum ada data untuk ${sid}`);
    return;
  }
  const ts = items[0].timestamp;
  const age = Math.max(0, (Date.now() - new Date(ts).getTime())/1000);
  setStatus('iotStatus', age < 120 ? 'ok' : 'warn', `Online (last ${Math.round(age)}s)`);
  adminLog(`IoT: data terakhir ${ts} (~${Math.round(age)}s lalu)`);
}

async function checkCDN() {
  try {
    await fetch(location.href, { method: 'GET', cache: 'no-store' });
    setStatus('cdnStatus', 'ok', 'Online');
    adminLog('CDN: OK (GitHub Pages)');
  } catch {
    setStatus('cdnStatus', 'err', 'Offline');
    adminLog('CDN: gagal di-fetch');
  }
}

async function refreshAWSStatus() {
  setStatus('apiStatus', 'warn', 'Checkingâ€¦');
  setStatus('lambdaStatus', 'warn', 'Checkingâ€¦');
  setStatus('dynamoStatus', 'warn', 'Checkingâ€¦');
  setStatus('iotStatus', 'warn', 'Checkingâ€¦');
  setStatus('cdnStatus', 'warn', 'Checkingâ€¦');

  try {
    const hist = await checkAPI();
    await checkIoT(hist);
  } catch (e) {
    setStatus('apiStatus', 'err', 'Offline');
    setStatus('lambdaStatus', 'err', 'Offline');
    setStatus('dynamoStatus', 'err', 'Unknown');
    setStatus('iotStatus', 'warn', 'Skip (API down)');
    adminLog('API check gagal: ' + e.message);
  }
  await checkCDN();
}

// ---- Enforce single-session UI saat masuk Dashboard ----
async function enforceSingleOpenUI(){
  try{
    const openId = await getOpenSessionId();
    if (openId) {
      attachUIToSession(openId);
    } else {
      // tidak ada sesi â†’ kembali ke form
      toggleSections('add');
      clearInterval(polling);
      currentPatient = null;
      clearSession();
    }
  }catch(e){
    // kalau gagal cek, biarkan form tampil tapi log error
    console.warn('enforceSingleOpenUI error:', e.message);
  }
}

// ---- Init ----
document.addEventListener('DOMContentLoaded',()=>{
  showPage('loginPage');
});
</script>
</body>
</html>
