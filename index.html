<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SUNSTONE - Lung Health Monitoring</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#f5f6fa;display:flex;justify-content:center;align-items:center;min-height:100vh}
    .container{max-width:1200px;width:100%;padding:20px}
    .page{display:none;background:#fff;border-radius:12px;box-shadow:0 4px 25px rgba(0,0,0,0.1);overflow:hidden}
    .page.active{display:block}
    .nav-btn{padding:10px 20px;border:2px solid #3b4998;background:#f8f9fa;color:#3b4998;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px}
    .nav-btn:hover,.nav-btn.active{background:#3b4998;color:#fff}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:2px solid #eee}
    .dashboard-title{color:#3b4998;font-size:30px;font-weight:bold}
    .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s}
    .btn-primary{background:#3b4998;color:#fff}
    .btn-primary:hover{background:#2d3875}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-sm{padding:6px 10px;font-size:13px}
    .add-patient-section{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px}
    .form-row{display:flex;gap:15px;margin-bottom:15px}
    .form-group{flex:1}
    .form-group label{font-weight:600;color:#333;display:block;margin-bottom:5px}
    .form-group input{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px}
    .current-patient{background:#e3f2fd;padding:20px;border-left:4px solid #3b4998;border-radius:8px;margin:20px}
    .status-badge{padding:4px 12px;border-radius:12px;font-weight:600;font-size:12px;margin-left:10px}
    .status-waiting{background:#fff3cd;color:#856404}
    .status-processing{background:#cce5ff;color:#0066cc}
    .status-completed{background:#d4edda;color:#155724}
    .loading-section{text-align:center;padding:20px;margin:20px}
    .loading-spinner{width:40px;height:40px;border:4px solid #ddd;border-top:4px solid #3b4998;border-radius:50%;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .result-section{background:#3b4998;color:white;padding:25px;border-radius:12px;margin:20px;text-align:center}
    .result-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:10px}
    .detail-item{background:rgba(255,255,255,0.1);padding:8px;border-radius:6px}
    .admin-page{padding:20px}
    .status-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .status-table th,.status-table td{padding:8px;border-bottom:1px solid #ddd;text-align:left}
    .log-container{background:#f8f9fa;padding:10px;border-radius:8px;font-family:monospace;max-height:250px;overflow-y:auto;font-size:12px}
    .log-entry{border-bottom:1px dashed #ccc;padding:3px 0}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f8f9fa;font-weight:600}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active" style="text-align:center;padding:50px">
      <h1 style="color:#3b4998;margin-bottom:30px;">SUNSTONE Admin Login</h1>
      <form id="loginForm" style="max-width:300px;margin:auto;">
        <input type="text" id="username" placeholder="Email" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <input type="password" id="password" placeholder="Password" required style="padding:10px;width:100%;margin-bottom:15px;border:2px solid #ccc;border-radius:6px;">
        <button class="btn btn-primary" style="width:100%;" type="submit">Login</button>
      </form>
      <p id="loginError" style="color:red;margin-top:10px;"></p>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">DASHBOARD</h1>
        <div class="nav-links">
          <button class="nav-btn active" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Add Patient Form -->
      <div id="addPatientSection" class="add-patient-section">
        <h3>Tambah Pasien Baru</h3>
        <form id="patientForm">
          <div class="form-row">
            <div class="form-group">
              <label>Nama Lengkap</label>
              <input id="patientName" type="text" required>
            </div>
            <div class="form-group">
              <label>Umur</label>
              <input id="patientAge" type="number" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>No HP</label>
              <input id="patientPhone" type="text" required>
            </div>
            <div class="form-group">
              <label>Index Brinkman</label>
              <input id="brinkmanIndex" type="text" required>
            </div>
          </div>
          <button class="btn btn-primary" type="submit">Mulai Sesi</button>
        </form>
      </div>

      <!-- Current Patient Info -->
      <div id="currentPatientSection" class="current-patient" style="display:none">
        <h4>Pasien Aktif <span id="patientStatus" class="status-badge status-waiting">Menunggu Data</span></h4>
        <p><b>Nama:</b> <span id="currentName">-</span> | <b>Umur:</b> <span id="currentAge">-</span> | <b>HP:</b> <span id="currentPhone">-</span></p>
        <button class="btn btn-danger" onclick="finishSession()">Selesai & Tutup Sesi</button>
      </div>

      <!-- Loading Section -->
      <div id="loadingSection" class="loading-section" style="display:none">
        <div class="loading-spinner"></div>
        <p id="realtimeStatus">Menunggu data sensor dari perangkat...</p>
      </div>

      <!-- Result Section -->
      <div id="resultSection" class="result-section" style="display:none">
        <h3>Hasil Analisis Machine Learning</h3>
        <p style="font-size:24px;margin:10px 0">Kategori PPOK: <b id="resultCategory">-</b></p>
        <p>Confidence: <b id="resultConfidence">-</b>%</p>
        <h4 style="margin-top:20px">Data Sensor Terbaru:</h4>
        <div id="resultDetails" class="result-details"></div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="historyPage" class="page">
      <div class="dashboard-header">
        <h1 class="dashboard-title">RIWAYAT PEMERIKSAAN</h1>
        <div class="nav-links">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn active" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
      </div>
      <div style="padding:20px">
        <button class="btn btn-primary" onclick="loadHistory()">Refresh Data</button>
        <table>
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Nama Pasien</th>
              <th>No HP</th>
              <th>Hasil PPOK</th>
              <th>Confidence</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="6" style="text-align:center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN PAGE -->
    <div id="adminPage" class="page">
      <div class="admin-page">
        <h1 style="color:#3b4998;margin-bottom:10px;">ADMIN PANEL - AWS Status</h1>
        <div class="nav-links" style="margin-bottom:15px">
          <button class="nav-btn" onclick="showDashboard(event)">Dashboard</button>
          <button class="nav-btn" onclick="showHistory(event)">Riwayat</button>
          <button class="nav-btn active" onclick="showAdmin(event)">Admin</button>
          <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
        </div>
        
        <h3>AWS Services Status</h3>
        <table class="status-table">
          <tr><th>Service</th><th>Status</th><th>Detail</th></tr>
          <tr>
            <td>IoT Core</td>
            <td id="iotStatus">🟡 Checking...</td>
            <td id="iotDetail">-</td>
          </tr>
          <tr>
            <td>Lambda Functions</td>
            <td id="lambdaStatus">🟡 Checking...</td>
            <td id="lambdaDetail">-</td>
          </tr>
          <tr>
            <td>DynamoDB</td>
            <td id="dynamoStatus">🟡 Checking...</td>
            <td id="dynamoDetail">-</td>
          </tr>
          <tr>
            <td>API Gateway</td>
            <td id="apiStatus">🟡 Checking...</td>
            <td id="apiDetail">-</td>
          </tr>
          <tr>
            <td>CDN (GitHub Pages)</td>
            <td id="cdnStatus">🟡 Checking...</td>
            <td id="cdnDetail">-</td>
          </tr>
        </table>
        
        <button class="btn btn-primary" onclick="refreshAWSStatus()">Refresh Status</button>
        
        <h3 style="margin-top:30px;">System Logs</h3>
        <div id="logContainer" class="log-container">
          <div class="log-entry">System initialized...</div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.6/dist/amazon-cognito-identity.min.js"></script>
<script>
/* ========================================================================
   KONFIGURASI AWS
   ======================================================================== */
const CONFIG = {
  cognito: {
    userPoolId: 'ap-southeast-1_JdYVBWDk0',
    clientId: '72tqj8vvf3bmc6r6f2k4h9hoc6',
    region: 'ap-southeast-1'
  },
  api: {
    url: 'https://8308ialq3d.execute-api.ap-southeast-1.amazonaws.com'
  }
};

/* ========================================================================
   STATE MANAGEMENT
   ======================================================================== */
let currentSession = null;
let pollingInterval = null;
let authToken = null;

/* ========================================================================
   COGNITO LOGIN
   ======================================================================== */
const poolData = {
  UserPoolId: CONFIG.cognito.userPoolId,
  ClientId: CONFIG.cognito.clientId
};
const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  const authData = {
    Username: username,
    Password: password
  };
  
  const authDetails = new AmazonCognitoIdentity.AuthenticationDetails(authData);
  const userData = {
    Username: username,
    Pool: userPool
  };
  
  const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
  
  cognitoUser.authenticateUser(authDetails, {
    onSuccess: function(result) {
      authToken = result.getIdToken().getJwtToken();
      addLog('Login berhasil!');
      document.getElementById('loginPage').classList.remove('active');
      document.getElementById('dashboardPage').classList.add('active');
      loadHistory();
    },
    onFailure: function(err) {
      document.getElementById('loginError').textContent = 'Login gagal: ' + err.message;
      addLog('Login gagal: ' + err.message);
    }
  });
});

function logout() {
  const cognitoUser = userPool.getCurrentUser();
  if (cognitoUser) {
    cognitoUser.signOut();
  }
  authToken = null;
  currentSession = null;
  stopPolling();
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('loginPage').classList.add('active');
  addLog('Logout berhasil');
}

/* ========================================================================
   NAVIGATION
   ======================================================================== */
function showDashboard(e) {
  switchPage('dashboardPage', e);
}

function showHistory(e) {
  switchPage('historyPage', e);
  loadHistory();
}

function showAdmin(e) {
  switchPage('adminPage', e);
  refreshAWSStatus();
}

function switchPage(pageId, event) {
  if (event) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
  }
  
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

/* ========================================================================
   SESSION MANAGEMENT
   ======================================================================== */
document.getElementById('patientForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const name = document.getElementById('patientName').value;
  const age = document.getElementById('patientAge').value;
  const phone = document.getElementById('patientPhone').value;
  const brinkman = document.getElementById('brinkmanIndex').value;
  
  try {
    const response = await fetch(`${CONFIG.api.url}/session`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authToken
      },
      body: JSON.stringify({
        name: name,
        age: parseInt(age),
        phone: phone,
        brinkman: brinkman,
        device_id: 'ESP01'
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      currentSession = data.id;
      
      document.getElementById('currentName').textContent = name;
      document.getElementById('currentAge').textContent = age;
      document.getElementById('currentPhone').textContent = phone;
      
      document.getElementById('addPatientSection').style.display = 'none';
      document.getElementById('currentPatientSection').style.display = 'block';
      document.getElementById('loadingSection').style.display = 'block';
      
      addLog(`Sesi dimulai: ${name} (${data.id})`);
      startPolling();
    } else {
      alert('Gagal membuat sesi: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
    addLog('Error membuat sesi: ' + err.message);
  }
});

async function finishSession() {
  if (!currentSession) return;
  
  try {
    const response = await fetch(`${CONFIG.api.url}/session/${currentSession}/finish`, {
      method: 'POST',
      headers: {
        'Authorization': authToken
      }
    });
    
    if (response.ok) {
      addLog(`Sesi selesai: ${currentSession}`);
      resetDashboard();
    }
  } catch (err) {
    addLog('Error finish session: ' + err.message);
  }
}

function resetDashboard() {
  stopPolling();
  currentSession = null;
  
  document.getElementById('addPatientSection').style.display = 'block';
  document.getElementById('currentPatientSection').style.display = 'none';
  document.getElementById('loadingSection').style.display = 'none';
  document.getElementById('resultSection').style.display = 'none';
  
  document.getElementById('patientForm').reset();
}

/* ========================================================================
   REALTIME POLLING
   ======================================================================== */
function startPolling() {
  if (pollingInterval) clearInterval(pollingInterval);
  
  pollingInterval = setInterval(async () => {
    if (!currentSession) return;
    
    try {
      const response = await fetch(`${CONFIG.api.url}/session/${currentSession}/latest`, {
        headers: {
          'Authorization': authToken
        }
      });
      
      const data = await response.json();
      
      if (data.latest) {
        displayResult(data.latest);
      } else {
        document.getElementById('realtimeStatus').textContent = 'Menunggu hasil analisis...';
      }
    } catch (err) {
      console.error('Polling error:', err);
    }
  }, 3000);
}

function stopPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
}

function displayResult(result) {
  document.getElementById('loadingSection').style.display = 'none';
  document.getElementById('resultSection').style.display = 'block';
  
  document.getElementById('resultCategory').textContent = result.category || '-';
  document.getElementById('resultConfidence').textContent = 
    result.confidence ? (result.confidence * 100).toFixed(1) : '-';
  
  document.getElementById('patientStatus').textContent = 'Selesai';
  document.getElementById('patientStatus').className = 'status-badge status-completed';
  
  addLog(`Hasil ML: ${result.category} (${(result.confidence * 100).toFixed(1)}%)`);
}

/* ========================================================================
   HISTORY
   ======================================================================== */
async function loadHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Loading...</td></tr>';
  
  try {
    const response = await fetch(`${CONFIG.api.url}/history`, {
      headers: {
        'Authorization': authToken
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Belum ada data</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.map(item => {
      const date = item.createdAt ? new Date(item.createdAt * 1000).toLocaleString('id-ID') : 
                   item.sessionStart ? new Date(item.sessionStart).toLocaleString('id-ID') : '-';
      const name = item.name || 'Unknown';
      const phone = item.phone || '-';
      const category = item.lastResultCategory || '-';
      const confidence = item.lastResultTimestamp ? '✓' : '-';
      const status = item.status || '-';
      
      return `<tr>
        <td>${date}</td>
        <td>${name}</td>
        <td>${phone}</td>
        <td>${category}</td>
        <td>${confidence}</td>
        <td>${status}</td>
      </tr>`;
    }).join('');
    
    addLog(`History loaded: ${data.length} records`);
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red">Error: ${err.message}</td></tr>`;
    addLog('Error loading history: ' + err.message);
  }
}

/* ========================================================================
   ADMIN - AWS STATUS CHECK
   ======================================================================== */
async function refreshAWSStatus() {
  addLog('Checking AWS services...');
  
  // Check API Gateway
  checkAPI();
  
  // Check CDN
  checkCDN();
  
  // IoT, Lambda, DynamoDB - simulated (butuh SDK atau endpoint khusus)
  updateStatus('iot', null, 'Requires AWS SDK');
  updateStatus('lambda', null, 'Requires AWS SDK');
  updateStatus('dynamo', null, 'Check via API calls');
}

async function checkAPI() {
  try {
    const response = await fetch(`${CONFIG.api.url}/history`, {
      headers: {
        'Authorization': authToken
      }
    });
    
    if (response.ok) {
      updateStatus('api', true, `HTTP ${response.status}`);
    } else {
      updateStatus('api', false, `HTTP ${response.status}`);
    }
  } catch (err) {
    updateStatus('api', false, err.message);
  }
}

async function checkCDN() {
  try {
    const response = await fetch(window.location.href, { method: 'HEAD' });
    if (response.ok) {
      updateStatus('cdn', true, 'Github Pages');
    } else {
      updateStatus('cdn', false, 'Not reachable');
    }
  } catch (err) {
    updateStatus('cdn', false, err.message);
  }
}

function updateStatus(service, isOk, detail) {
  const statusEl = document.getElementById(`${service}Status`);
  const detailEl = document.getElementById(`${service}Detail`);
  
  if (isOk === true) {
    statusEl.textContent = '🟢 Online';
    statusEl.style.color = 'green';
  } else if (isOk === false) {
    statusEl.textContent = '🔴 Offline';
    statusEl.style.color = 'red';
  } else {
    statusEl.textContent = '🟡 Unknown';
    statusEl.style.color = 'orange';
  }
  
  if (detailEl) {
    detailEl.textContent = detail || '-';
  }
  
  addLog(`${service.toUpperCase()}: ${isOk === true ? 'Ok' : isOk === false ? 'Failed' : 'Unknown'} (${detail})`);
}

/* ========================================================================
   LOGGING
   ======================================================================== */
function addLog(message) {
  const logContainer = document.getElementById('logContainer');
  const timestamp = new Date().toLocaleTimeString('id-ID');
  const logEntry = document.createElement('div');
  logEntry.className = 'log-entry';
  logEntry.textContent = `[${timestamp}] ${message}`;
  logContainer.appendChild(logEntry);
  logContainer.scrollTop = logContainer.scrollHeight;
  console.log(`[${timestamp}] ${message}`);
}

/* ========================================================================
   INITIALIZATION
   ======================================================================== */
window.addEventListener('load', function() {
  addLog('SUNSTONE System Ready');
  
  // Check if already logged in
  const cognitoUser = userPool.getCurrentUser();
  if (cognitoUser) {
    cognitoUser.getSession(function(err, session) {
      if (!err && session.isValid()) {
        authToken = session.getIdToken().getJwtToken();
        document.getElementById('loginPage').classList.remove('active');
        document.getElementById('dashboardPage').classList.add('active');
        addLog('Auto-login berhasil');
      }
    });
  }
});
</script>
</body>
</html>
